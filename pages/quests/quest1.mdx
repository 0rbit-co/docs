# Price Feed Bot

## Challenge: The Quest for 0rbit Points

 - üåüYour mission is to create a bot that responds to user queries for token prices, fetching the data using 0rbit's ao process and the CoinGecko API.
 -  **üìö**The bot will be evaluated based on the live demo and the codebase. Submit a PR <a href="https://github.com/0rbit-co/quest" style={{ color: 'white', textDecoration: 'underline' }}>here</a> with the Name= `price-feed-bot-${username}` and with the codebase and demo link in the description.
- üí´ Meanwhile, Meet other builders working on this quest and get help in the 0rbit‚Äôs <a href="https://discord.gg/x6QjBuZFZr" style={{ color: 'white', textDecoration: 'underline' }}>Discord</a> Channel!

## üìùPre-Requisites:

Basic understanding of aos
##
#### **Checkpoint 0:¬†üì¶ Environment**

1. Node (‚â•v20.0)
2. Yarn or npm
3. A code editor of your choice

#### **Checkpoint 1: üìù Start the editor**

```lua
aos> .editor
```

This will start the editor for you to write the commands to interact with the¬†`ao`¬†processes.

#### **Checkpoint 2: üõ† JSON Module**

To begin, we need to import the JSON module into our **aos** process. 

```lua
aos> local json = require("json")
```

The JSON module is required in your script to handle JSON data. In the provided codebase, you are interacting with an API (api.coingecko.com) to fetch cryptocurrency prices. The data returned by this API is typically in JSON format. Therefore, you need to parse this JSON data to extract the required information, such as cryptocurrency prices. We will look into how to do this in a later step.

For more detailed information on how to use the JSON module, you can visit the documentation at: [JSON Module Documentation](https://cookbook_ao.arweave.dev/guides/aos/modules/json.html)

> Congratulations! You've just written your first line for the quest! üéâ
> 

#### **Checkpoint 3: üß≠ Constants**

```lua
aos> _0RBIT = "WSXUI2JjYUldJ7CKq9wE1MGwXs-ldzlUlHOQszwQe0s"
```

This constant represents the process ID of the 0rbit process. It is a unique identifier used for communication or interaction with the 0rbit‚Äôs ao process.

```lua
aos> BASE_URL = "[https://api.coingecko.com/api/v3/simple/price](https://api.coingecko.com/api/v3/simple/price)"
```

This constant holds the base URL for the Coingecko API.

> Remember, every small step counts towards progress! üöÄ
> 

#### **Checkpoint 4: üì¶ Token Prices Initialization**

We initialize the **`TOKEN_PRICES`** table, which stores information about token prices. If the **`TOKEN_PRICES`** table is not already defined, we initialize it with default values for Bitcoin (BTC), Ethereum (ETH), and Solana (SOL).

```lua
TOKEN_PRICES = TOKEN_PRICES or {
	BTC = {
		coingecko_id = "bitcoin",
		price = 0,
		last_update_timestamp = 0
	},
	ETH = {
		coingecko_id = "ethereum",
		price = 0,
		last_update_timestamp = 0
	},
	SOL = {
		coingecko_id = "solana",
		price = 0,
		last_update_timestamp = 0
	}
}
```

> Keep up the momentum, you're doing great! üöÄ
> 

#### **Checkpoint 5: üîÑ Requested Tokens and Logging Initialization**

Initialize the **`REQUESTED_TOKENS` and `LOGS`** table, which stores information about tokens that have been requested to be added to the price feed

```lua
REQUESTED_TOKENS = REQUESTED_TOKENS or {}
```

```lua
LOGS = LOGS or {}
```

> You're halfway there! Keep up the great work, and let's tackle the next checkpoint together! üéâ
> 

#### **Checkpoint 6: üõ†Ô∏è Token Addition Handler**

Define a handler for adding tokens to the price feed.

<br />
<i>**6.1: Handler Definition**</i>

```lua
Handlers.add(
	"AddToken",
	Handlers.utils.hasMatchingTag("Action", "Add-Token"),
	function(msg)
```

<i>**6.2: Checking Process Owner and Extracting Token Information**</i>

```lua
if msg.From == ao.id then
	local token = msg.Tags.Token
  local coingecko_id = msg.Tags.CoingeckoId
```

<i>**6.3: Adding token to TOKEN_PRICES Table**</i>

```lua
if not TOKEN_PRICES[token] then
    TOKEN_PRICES[token].price = 0
    TOKEN_PRICES[token].coingecko_id = coingecko_id
    ao.send({
        Target = msg.From,
        Tags = {
            Action = 'Add Token Success',
            ['Message-Id'] = msg.Id,
            Token = token
        }
    })
else
    ao.send({
        Target = msg.From,
        Tags = {
            Action = 'Add Token Error',
            ['Message-Id'] = msg.Id,
            Error = 'Token already exists'
        }
    })
end
```

<i>**6.4 Logging for Debugging**</i>

```lua
table.insert(
    LOGS,
    {
        From = msg.From,
        Tag = "Add-Token",
        Data = {
            Token = token,
            Message = "Success"
        }
    }
)
```

üëÄ At last your handler will look like this üëáüèª

```lua
Handlers.add(
    "AddToken",
    Handlers.utils.hasMatchingTag("Action", "Add-Token"),
    function(msg)
        if msg.From == ao.id then
            local token = msg.Tags.Token
            local coingecko_id = msg.Tags.CoingeckoId

            if not TOKEN_PRICES[token] then
                TOKEN_PRICES[token].price = 0
                TOKEN_PRICES[token].coingecko_id = coingecko_id
                ao.send({
                    Target = msg.From,
                    Tags = {
                        Action = 'Add Token Success',
                        ['Message-Id'] = msg.Id,
                        Token = token
                    }
                })
            else
                ao.send({
                    Target = msg.From,
                    Tags = {
                        Action = 'Add Token Error',
                        ['Message-Id'] = msg.Id,
                        Error = 'Token already exists'
                    }
                })
            end

            -- For Debugging
            table.insert(
                LOGS,
                {
                    From = msg.From,
                    Tag = "Add-Token",
                    Data = {
                        Token = token,
                        Message = "Success"
                    }
                }
            )
        else
            ao.send({
                Target = msg.From,
                Tags = {
                    Action = 'Add Token Error',
                    ['Message-Id'] = msg.Id,
                    Error = 'Only the Process Owner can add tokens'
                }
            })

            -- For Debugging
            table.insert(
                LOGS,
                {
                    From = msg.From,
                    Tag = "Add-Token",
                    Data = {
                        Message = "Not Owner"
                    }
                }
            )
        end
    end
)
```

> You just created your first handler! üéâ
> 
 

#### **Checkpoint 7: **üñ®** Retrieving Token Price**
<br />
<i>**7.1 Handler Definition**</i>

```lua
Handlers.add(
    "GetPrice",
    Handlers.utils.hasMatchingTag("Action", "Get-Price"),
    function(msg)
```

<i>**7.2 Extracting Token and Price**</i>

```lua
local token = msg.Tags.Token
local price = TOKEN_PRICES[token].price
```

<i>**7.3 Checking Price Availability**</i>

```lua
if price == 0 then
    ao.send({
        Target = msg.From,
        Tags = {
            Action = 'Get-Price Error',
            ['Message-Id'] = msg.Id,
            Error = 'Price not available! Please contact @0rbitco on X'
        }
    })
    return
else

```

<i>**7.4 Sending Price to the Sender**</i>

```lua
ao.send({
    Target = msg.From,
    Tags = {
        Action = 'Get-Price',
        ['Message-Id'] = msg.Id,
        Price = tostring(price)
    }
})

```

<i>**7.5 Logging for Debugging**</i>

```lua
table.insert(
    LOGS,
    {
        From = msg.From,
        Tag = "Request-Add-Token",
        Data = {
            Token = token,
            Message = "Success"
        }
    }
)
```

üëÄ At last your handler will look like this üëáüèª

```lua
Handlers.add(
    "GetPrice",
    Handlers.utils.hasMatchingTag("Action", "Get-Price"),
    function(msg)
        local token = msg.Tags.Token
        local price = TOKEN_PRICES[token].price
        if price == 0 then
            ao.send({
                Target = msg.From,
                Tags = {
                    Action = 'Get-Price Error',
                    ['Message-Id'] = msg.Id,
                    Error = 'Price not available! Please contact @0rbitco on X'
                }
            })
            return
        else
            ao.send({
                Target = msg.From,
                Tags = {
                    Action = 'Get-Price',
                    ['Message-Id'] = msg.Id,
                    Price = tostring(price)
                }
            })
        end
        table.insert(
            LOGS,
            {
                From = msg.From,
                Tag = "Request-Add-Token",
                Data = {
                    Token = token,
                    Message = "Success"
                }
            }
        )
    end
)
```

> Remember, just like planets in space, you're moving forward on your own journey. Keep taking steps and you'll reach your destination. üöÄ
> 

#### **Checkpoint 8: üî•Token Price Update**
<br />
<i>**8.1 CRON Function for Token Price Update**</i>

```lua
Handlers.add(
    "CronTick",
    Handlers.utils.hasMatchingTag("Action", "Cron"),
    function()
        local url;
        local token_ids;

        for _, v in pairs(TOKEN_PRICES) do
            token_ids = token_ids .. v.coingecko_id .. ","
        end

        url = BASE_URL .. "?ids=" .. token_ids .. "&vs_currencies=usd"

        ao.send({
            Target = _0RBIT,
            Action = "Get-Real-Data",
            Url = url
        })
    end
)
```

<i>**8.2: Handling Received Data for Token Price Update**</i>

```lua
Handlers.add(
    "ReceivingData",
    Handlers.utils.hasMatchingTag("Action", "Receive-data-feed"),
    function(msg)
        local res = json.decode(msg.Data)
        for k, v in pairs(res) do
            TOKEN_PRICES[k].price = v
            TOKEN_PRICES[k].last_update_timestamp = msg.Timestamp
        end
    end
)
```

> Congratulations on making it this far! ü•≥ You're already part of our family. Don't forget to join us on <a href="https://discord.gg/x6QjBuZFZr" style={{ color: 'white', textDecoration: 'underline' }}>Discord</a> for more discussions and updates. We're excited to have you with us on this journey! üöÄ
> 

#### **Checkpoint 9: üìù Close the editor**

```lua
>aos .done
```

This will end your editor session, compile the commands and execute it.

#### **Checkpoint 10: ‚úÖ Check the Inbox**

Now you can check the inbox of your `ao` process to see the response from the **0rbit**.
```lua
aos> Send({Target=ao.id, Action="Get-Price", Token="BTC"})
```
```lua
aos> Inbox[#Inbox].Data
```

> *Voila! You have successfully completed your first¬†Quest to the¬†**0rbit**. üéâüéâ*
> 

## Submission:

```lua
Send({Target= "O3SXXYqQCNTbBedJjsW6wkPnrKFZq8DPLkKjO7zhztE", Action = "Claim", Quest = "Price-Bot", User = <username>})
```

## Points:

> Note: It will take a little time after we recieve your request. Once you get the message for Credit-Notice run following to check balance.
> 

> In the meantime, feel free to say hi to us on our <a href="https://twitter.com/0rbitco" style={{color: "white", textDecoration: "underline"}}>Twitter</a> page! üòâ
> 
- 200000 OP (0rbit Points) will be awarded to PR after the successful evaluation.
- You can check your OP balance by using the following commands in your terminal

```lua
aos> Send({Target= "BUhZLMwQ6yZHguLtJYA5lLUa9LQzLXMXRfaq9FVcPJc", Action = "Balance"})
```