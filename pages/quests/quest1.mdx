# Price Feed
import { Callout } from 'nextra/components'

Your mission is to create a bot that responds to user queries for token prices, fetching the data using **0rbit's `ao` process.**

## Pre-Requisites

- Basic understanding of aos

## **Checkpoint 1: üìù Start the editor**

```lua
aos> .editor
```

This will start the editor for you to write the commands to interact with the¬†`ao`¬†processes.

## **Checkpoint 2: üõ† JSON Module**

To begin, we need to import the JSON module into our **aos** process. 

```lua
local json = require("json")
```

The JSON module is required in your script to handle JSON data. In the provided codebase, you are interacting with an API (api.coingecko.com) to fetch cryptocurrency prices. The data returned by this API is typically in JSON format. Therefore, you need to parse this JSON data to extract the required information, such as cryptocurrency prices. We will look into how to do this in a later step.

For more detailed information on how to use the JSON module, you can visit the documentation at: [JSON Module Documentation](https://cookbook_ao.arweave.dev/guides/aos/modules/json.html)

> Congratulations! You've just written your first line for the quest! üéâ
> 

## **Checkpoint 3: üß≠ Constants**

```lua
_0RBIT = "WSXUI2JjYUldJ7CKq9wE1MGwXs-ldzlUlHOQszwQe0s"
```

This constant represents the process ID of the 0rbit process. It is a unique identifier used for communication or interaction with the 0rbit‚Äôs ao process.

```lua
BASE_URL = "https://api.coingecko.com/api/v3/simple/price"
```

This constant holds the base URL for the Coingecko API.

> Remember, every small step counts towards progress! üöÄ
> 

## **Checkpoint 4: üì¶ Token Prices Initialization**

We initialize the **`TOKEN_PRICES`** table, which stores information about token prices. If the **`TOKEN_PRICES`** table is not already defined, we initialize it with default values for Bitcoin (BTC), Ethereum (ETH), and Solana (SOL).

```lua
TOKEN_PRICES = TOKEN_PRICES or {
	BTC = {
		coingecko_id = "bitcoin",
		price = 0,
		last_update_timestamp = 0
	},
	ETH = {
		coingecko_id = "ethereum",
		price = 0,
		last_update_timestamp = 0
	},
	SOL = {
		coingecko_id = "solana",
		price = 0,
		last_update_timestamp = 0
	}
}
```

> Keep up the momentum, you're doing great! üöÄ
> 

## **Checkpoint 5: üîÑ Requested Tokens and Logging Initialization**

Initialize the **`REQUESTED_TOKENS` and `LOGS`** table, which stores information about tokens that have been requested to be added to the price feed

```lua
REQUESTED_TOKENS = REQUESTED_TOKENS or {}
```

```lua
LOGS = LOGS or {}
```

> You're halfway there! Keep up the great work, and let's tackle the next checkpoint together! üéâ
> 

## **Checkpoint 6: üõ†Ô∏è Token Addition Handler**

Define a handler for adding tokens to the price feed.

<br />

<i>**6.1: Handler Definition**</i>
<br />
The `Handlers.add` function adds a new handler or updates an existing handler by name. <br />
Next up is Handlers.utils library which provides two functions that are common matching patterns and one function that is a common handle function.
The `Handlers.utils.hasMatchingTag` returns a function that requires a message argument, so you can drop this into any pattern argument on the Handlers module. The function compares the Tag Name and Value, if they are equal then it invokes the handle function.

```lua
Handlers.add(
	"AddToken",
	Handlers.utils.hasMatchingTag("Action", "Add-Token"),
	function(msg)
```

<i>**6.2: Checking Process Owner and Extracting Token Information**</i>

In this snippet, msg.From and msg.Tags are utilized to access a particular attribute within the structured message. For further reference on the specific structure of the message, visit <a href="https://cookbook_ao.arweave.dev/concepts/messages.html" style={{color: "orange", textDecoration: "underline"}}>here</a>.

```lua
if msg.From == ao.id then
	local token = msg.Tags.Token
    local coingecko_id = msg.Tags.CoingeckoId
```

<i>**6.3: Adding token to TOKEN_PRICES Table**</i>

These lines of code first check if a token exists in the TOKEN_PRICES table. If not, it initializes its price to 0 and sets its coingecko_id. Then, it sends a success message to msg.From with relevant tags. Otherwise, it sends an error message indicating that the token already exists.

```lua
if not TOKEN_PRICES[token] then
    TOKEN_PRICES[token].price = 0
    TOKEN_PRICES[token].coingecko_id = coingecko_id
    ao.send({
        Target = msg.From,
        Tags = {
            Action = 'Add Token Success',
            ['Message-Id'] = msg.Id,
            Token = token
        }
    })
else
    ao.send({
        Target = msg.From,
        Tags = {
            Action = 'Add Token Error',
            ['Message-Id'] = msg.Id,
            Error = 'Token already exists'
        }
    })
end
```

<i>**6.4 Logging for Debugging**</i>

```lua
table.insert(
    LOGS,
    {
        From = msg.From,
        Tag = "Add-Token",
        Data = {
            Token = token,
            Message = "Success"
        }
    }
)
```

üëÄ At last your handler will look like this üëáüèª

```lua
Handlers.add(
    "AddToken",
    Handlers.utils.hasMatchingTag("Action", "Add-Token"),
    function(msg)
        if msg.From == ao.id then
            local token = msg.Tags.Token
            local coingecko_id = msg.Tags.CoingeckoId

            if not TOKEN_PRICES[token] then
                TOKEN_PRICES[token].price = 0
                TOKEN_PRICES[token].coingecko_id = coingecko_id
                ao.send({
                    Target = msg.From,
                    Tags = {
                        Action = 'Add Token Success',
                        ['Message-Id'] = msg.Id,
                        Token = token
                    }
                })
            else
                ao.send({
                    Target = msg.From,
                    Tags = {
                        Action = 'Add Token Error',
                        ['Message-Id'] = msg.Id,
                        Error = 'Token already exists'
                    }
                })
            end

            -- For Debugging
            table.insert(
                LOGS,
                {
                    From = msg.From,
                    Tag = "Add-Token",
                    Data = {
                        Token = token,
                        Message = "Success"
                    }
                }
            )
        else
            ao.send({
                Target = msg.From,
                Tags = {
                    Action = 'Add Token Error',
                    ['Message-Id'] = msg.Id,
                    Error = 'Only the Process Owner can add tokens'
                }
            })

            -- For Debugging
            table.insert(
                LOGS,
                {
                    From = msg.From,
                    Tag = "Add-Token",
                    Data = {
                        Message = "Not Owner"
                    }
                }
            )
        end
    end
)
```

> You just created your first handler! üéâ
> 
 

## **Checkpoint 7: **üñ®** Retrieving Token Price**
<br />
<i>**7.1 Handler Definition**</i>

Every Handler Definition follows the same format, as explained in step 6.1. To learn more about how handlers function in ao, you can find additional information <a href="https://cookbook_ao.arweave.dev/references/handlers.html" style={{color: "orange", textDecoration: "underline"}}>here</a>.

```lua
Handlers.add(
    "GetPrice",
    Handlers.utils.hasMatchingTag("Action", "Get-Price"),
    function(msg)
```

<i>**7.2 Extracting Token and Price**</i>

```lua
local token = msg.Tags.Token
local price = TOKEN_PRICES[token].price
```

<i>**7.3 Checking Price Availability**</i>

It checks if the `price` of a token is equal to 0. If so, it sends an error message. If the `price` is not zero, the execution continues.

```lua
if price == 0 then
    ao.send({
        Target = msg.From,
        Tags = {
            Action = 'Get-Price Error',
            ['Message-Id'] = msg.Id,
            Error = 'Price not available! Please contact @0rbitco on X'
        }
    })
    return
else
```

<i>**7.4 Sending Price to the Sender**</i>

Here, `ao.send` sends a message to the Sender's Process ID.

```lua
ao.send({
    Target = msg.From,
    Tags = {
        Action = 'Get-Price',
        ['Message-Id'] = msg.Id,
        Price = tostring(price)
    }
})

```

<i>**7.5 Logging for Debugging**</i>

```lua
table.insert(
    LOGS,
    {
        From = msg.From,
        Tag = "Request-Add-Token",
        Data = {
            Token = token,
            Message = "Success"
        }
    }
)
```

üëÄ At last your handler will look like this üëáüèª

```lua
Handlers.add(
    "GetPrice",
    Handlers.utils.hasMatchingTag("Action", "Get-Price"),
    function(msg)
        local token = msg.Tags.Token
        local price = TOKEN_PRICES[token].price
        if price == 0 then
            ao.send({
                Target = msg.From,
                Tags = {
                    Action = 'Get-Price Error',
                    ['Message-Id'] = msg.Id,
                    Error = 'Price not available! Please contact @0rbitco on X'
                }
            })
            return
        else
            ao.send({
                Target = msg.From,
                Tags = {
                    Action = 'Get-Price',
                    ['Message-Id'] = msg.Id,
                    Price = tostring(price)
                }
            })
        end
        table.insert(
            LOGS,
            {
                From = msg.From,
                Tag = "Request-Add-Token",
                Data = {
                    Token = token,
                    Message = "Success"
                }
            }
        )
    end
)
```

> Remember, just like planets in space, you're moving forward on your own journey. Keep taking steps and you'll reach your destination. üöÄ
> 

## **Checkpoint 8: üî•Token Price Update**
<br />
<i>**8.1 CRON Function for Token Price Update**</i> <br />
`ao` has the ability to generate messages on a specified interval, this interval could be seconds, minutes, hours, or blocks. <br />
Every cron message has an Action tag with the value Cron. Handlers can be defined to perform specific tasks autonomously, each time a cron message is received.

```lua
Handlers.add(
    "CronTick",
    Handlers.utils.hasMatchingTag("Action", "Cron"),
    function()
        local url;
        local token_ids;

        for _, v in pairs(TOKEN_PRICES) do
            token_ids = token_ids .. v.coingecko_id .. ","
        end

        url = BASE_URL .. "?ids=" .. token_ids .. "&vs_currencies=usd"

        ao.send({
            Target = _0RBIT,
            Action = "Get-Real-Data",
            Url = url
        })
    end
)
```

<i>**8.2: Handling Received Data for Token Price Update**</i>

```lua
Handlers.add(
    "ReceivingData",
    Handlers.utils.hasMatchingTag("Action", "Receive-data-feed"),
    function(msg)
        local res = json.decode(msg.Data)
        for k, v in pairs(res) do
            TOKEN_PRICES[k].price = v
            TOKEN_PRICES[k].last_update_timestamp = msg.Timestamp
        end
    end
)
```

> Congratulations on making it this far! ü•≥ You're already part of our family. Don't forget to join us on <a href="https://discord.gg/x6QjBuZFZr" style={{ color: 'white', textDecoration: 'underline' }}>Discord</a> for more discussions and updates. We're excited to have you with us on this journey! üöÄ
> 

## **Checkpoint 9: üìù Close the editor**

```lua
aos> .done
```

This will end your editor session, compile the commands and execute it.

## **Checkpoint 10: ‚úÖ Check the Inbox**

Now you can check the inbox of your `ao` process to see the response from the **0rbit**.
```lua
aos> Send({Target=ao.id, Action="Get-Price", Token="BTC"})
```
```lua
aos> Inbox[#Inbox].Data
```

> *Voila! You have successfully completed your first¬†Quest to the¬†**0rbit**. üéâüéâ*
> 

## Submission

This is a two step process:

1. Create a PR <a href="https://github.com/0rbit-co/quest/pulls" style={{color: "orange", textDecoration: "underline"}}>here</a>

- **title**: `${your_username}-price-feed` 
- **description**: Add the process ID of your Price Feed Process and your wallet address. 

2. Send `CLAIM` request
    ```lua
    aos> Send({Target= "O3SXXYqQCNTbBedJjsW6wkPnrKFZq8DPLkKjO7zhztE", Action = "Claim", Quest = "Price-Bot", User = <username>})
    ```

<Callout emoji="üëæ">
  **200 $0RBT** will be awarded to your Wallet Address after the successful evaluation.
</Callout>

---

If you have any queries, let us know in the *[Discord channel](https://discord.gg/JVSjqaKJgV) ü´°*

